@startuml
'https://plantuml.com/sequence-diagram

actor xxl_job
xxl_job -> 门店生产: 触发高峰期店铺断货提醒逻辑
门店生产 -> 门店宝: 查询灰度店铺配置
opt 灰度店铺配置为空
门店生产 -> xxl_job: end
end

loop 按灰度店铺循环
    门店生产 -> 效期贴或店铺中心: 查询门店打烊时间
    门店生产 -> 门店生产: 计算提醒时间=打烊时间h-2
    opt 当前时间 > 提醒时间
    门店生产 -> 门店生产: continue;
    end
    门店生产 -> 数仓: 查询解冻预测用量接口
    门店生产 -> 数仓: 查询包材用量接口
    门店生产 -> 门店生产: 计算解冻推送数据
    门店生产 -> 门店生产: 计算包材推送数据
	门店生产 -> 门店生产: 组装推送消息
	门店生产 -> 门店生产: 组装推送消息对应的生产计划明细（时间轴明细）
	门店生产 -> 门店生产DB: 生产计划消息、生产计划明细数据持久化(事物)
    门店生产 -> 设备中心: 推送店铺高峰期断货提醒 以待前端取用
	门店生产 -> 设备中心: 追加推送生产计划明细（时间轴明细）
end
@enduml